---

# this playbooks needs lab-specific information
# to obtain this information scp /etc/sysconfig/workshopper from the guide nodes
# run this playbook with the environment variables like this
#
#    env $(cat workshopper | xargs) ansible-playbook cns-deploy_automation.yml
#

  - hosts: localhost

    tasks:

      - name: create firewall-playbook
        blockinfile:
          create: yes
          dest: configure-firewall.yml
          state: present
          block: |
            - hosts: cns

              tasks:

                - name: insert iptables rules required for GlusterFS
                  blockinfile:
                    dest: /etc/sysconfig/iptables
                    block: |
                      -A OS_FIREWALL_ALLOW -p tcp -m state --state NEW -m tcp --dport 24007 -j ACCEPT
                      -A OS_FIREWALL_ALLOW -p tcp -m state --state NEW -m tcp --dport 24008 -j ACCEPT
                      -A OS_FIREWALL_ALLOW -p tcp -m state --state NEW -m tcp --dport 2222 -j ACCEPT
                      -A OS_FIREWALL_ALLOW -p tcp -m state --state NEW -m multiport --dports 49152:49664 -j ACCEPT
                    insertbefore: "^COMMIT"

                - name: reload iptables
                  systemd:
                    name: iptables
                    state: reloaded

            ...

      - name: run firewall-playbook
        shell: ansible-playbook configure-firewall.yml

      - name: login via oc as system:admin to default namespace
        shell: oc login -u system:admin -n default

      - name: create new project
        shell: oc new-project {{ lookup('env','CNS_NAMESPACE') | default('container-native-storage') }}

      - name: add privileges to default service account
        shell: oadm policy add-scc-to-user privileged -z default

      - name: check topology file
        stat:
          path: /home/ec2-user/topology.json
        register: topology_file

      - fail:
          msg: "Error! topology file not found in /home/ec2-user/topology.json"
        when: not topology_file.stat.isreg

      - name: run cns-deploy
        shell: cns-deploy --yes -n {{ lookup('env','CNS_NAMESPACE') | default('container-native-storage') }} -g /home/ec2-user/topology.json --admin-key '{{ lookup('env','HEKETI_ADMIN_PW') | default('myS3cr3tpassw0rd') }}' --user-key '{{ lookup('env','HEKETI_USER_PW') | default('mys3rs3cr3tpassw0rd') }}'
...
