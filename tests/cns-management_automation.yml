---

  - hosts: localhost

    tasks:

      - include_vars: /opt/lab/environment.yml

      - name: login as fancyuser1
        shell: oc login -u 'fancyuser1' -p 'openshift'

      - name: create new project called 'my-database-app'
        shell: oc new-project my-database-app

      - name: export the rails-postgres-persistent template
        shell: oc export template/rails-pgsql-persistent -n openshift -o yaml > rails-app-template.yml
        args:
          creates: rails-app-template.yml

      - name: render the rails-postgres-persistent template with custom volume capacity
        shell: oc process -f rails-app-template.yml -o yaml -p VOLUME_CAPACITY=15Gi > my-rails-app.yml
        args:
          creates: my-rails-app.yml

      - name: deploy app
        shell: oc create -f my-rails-app.yml

      - name: wait for app to be ready
        shell: oc get rc -o jsonpath='{$.items[?(@.spec.selector.name=="rails-pgsql-persistent")].status.readyReplicas}'
        register: app_rc_check
        until: app_rc_check.stdout == 1
        retries: 30
        delay: 10
...
