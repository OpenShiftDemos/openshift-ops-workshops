---

  - hosts: localhost

    tasks:

      - include_vars: /opt/lab/environment.yml

      - name: login as fancyuser1
        shell: oc login -u 'fancyuser1' -p 'openshift'

      - name: create new project called 'my-database-app'
        shell: oc new-project my-database-app

      - name: export the rails-postgres-persistent template
        shell: oc export template/rails-pgsql-persistent -n openshift -o yaml > rails-app-template.yml
        args:
          creates: rails-app-template.yml

      - name: render the rails-postgres-persistent template with custom volume capacity
        shell: oc process -f rails-app-template.yml -o yaml -p VOLUME_CAPACITY=15Gi > my-rails-app.yml
        args:
          creates: my-rails-app.yml

      - name: deploy app
        shell: oc create -f my-rails-app.yml

      - name: wait for app to be ready
        shell: oc get rc -o jsonpath='{$.items[?(@.spec.selector.name=="rails-pgsql-persistent")].status.readyReplicas}'
        register: app_rc_check
        until: app_rc_check.stdout == "1"
        retries: 60
        delay: 10

      - name: check pvc
        shell: oc get pvc/postgresql

      - name: check route
        shell: oc get route/rails-pgsql-persistent

      - name: re-login as system:admin
        shell: oc login -u system:admin

      - name: change to project of fancyuser1
        shell:  oc project my-database-app

      - name: get pvc
        shell: oc get pvc/postgresql -o jsonpath='{$.spec.volumeName}'
        register: pgsql_pv
        failed_when: pgsql_pv.stdout == ""

      - set_fact:
          rwo_pv: "{{ pgsql_pv.stdout }}"

      - name: get pv
        shell: oc get pv/{{ rwo_pv }} -o jsonpath='{$.spec.glusterfs.path}'
        register: pgsql_vol
        failed_when: pgsql_vol.stdout == ""

      - set_fact:
          rwo_gvol: "{{ pgsql_vol.stdout }}"
          cns_namespace: "{{ CNS_NAMESPACE }}"

      - name: get first glusterfs pods hostIP
        shell: oc get pods -n {{ cns_namespace }} -o jsonpath='{$.items[0].metadata.name}'
        register: first_glusterfs_pod
        failed_when: first_glusterfs_pod.stdout == ""

      - set_fact:
          gluster_pod: "{{ first_glusterfs_pod.stdout }}"

      - name: search for gluster vol based on pv
        shell: oc rsh -n {{ cns_namespace }} {{ gluster_pod }} gluster vol list
        register: gluster_vol_list
        failed_when: gluster_vol_list.rc != 0 or rwo_gvol not in gluster_vol_list.stdout


...
