---
- name: Verification of successful OpenShift installation
  hosts: masters
  tasks:

    - include_vars: /opt/lab/environment.yml

    - set_fact:
        api_health_url: "{{ API_HEALTH_URL }}"
        ocp_routing_suffix: "{{ OCP_ROUTING_SUFFIX }}"

    - name: Validate the public address
      uri:
        url: "{{ api_health_url }}"
        validate_certs: False
        status_code: 200
        method: GET

    - name: login as cluster admin
      shell: oc login -u system:admin
      changed_when: false

    - name: Create the validation project
      command: "oc new-project validate"

    - name: Create Hello world app
      shell: "oc new-app cakephp-mysql-example"

    - name: wait for msql db to be ready
      shell: oc get rc -o jsonpath='{$.items[?(@.spec.selector.name=="mysql")].status.readyReplicas}'
      register: cakephp_app_rc_check
      until: cakephp_app_rc_check.stdout == "1"
      changed_when: false
      retries: 60
      delay: 10

    - name: wait for cake-php app to be ready
      shell: oc get rc -o jsonpath='{$.items[?(@.spec.selector.name=="cakephp-mysql-example")].status.readyReplicas}'
      register: cakephp_app_rc_check
      until: cakephp_app_rc_check.stdout == "1"
      changed_when: false
      retries: 60
      delay: 10

    - name: check the status of the page
      uri:
        url: "http://cakephp-mysql-example-validate.{{ ocp_routing_suffix }}"
        status_code: 200
        method: GET
      register: cakephp_app_route_check
      until: result|success and result.status == 200
      retries: 60
      delay: 10

    - name: Delete the Project
      command: "oc delete project validate"
